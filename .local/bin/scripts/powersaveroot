#!/usr/bin/env bash

# Exit when non-zero status
# Unset Variable -> exit error
# Stop on errored pipe |
set -euo pipefail

# if not on root, relaunch the command
if [ "$EUID" -ne 0 ]; then
    exec sudo "$0" "$@"
fi

echo "Running root powersave actions..."

if [ "$1" = "on" ]; then
    set_epp_hint power
    ryzenadj -a 15000 -b 30000 -c 20000 --power-saving
    echo 0 >/sys/devices/system/cpu/cpufreq/boost
    echo powersave >/sys/module/pcie_aspm/parameters/policy
    echo 1500 >/proc/sys/vm/dirty_writeback_centisecs
    echo 5 >/proc/sys/vm/laptop_mode
    echo 0 >/proc/sys/kernel/nmi_watchdog
elif [ "$1" = "off" ]; then
    ryzenadj -a 25000 -b 25000 -c 25000
    set_epp_hint performance
    echo 1 >/sys/devices/system/cpu/cpufreq/boost
    echo default >/sys/module/pcie_aspm/parameters/policy
    echo 500 >/proc/sys/vm/dirty_writeback_centisecs
    echo 0 >/proc/sys/vm/laptop_mode
    echo 1 >/proc/sys/kernel/nmi_watchdog
else
    echo "Usage: $0 [off|on]"
    exit 1
fi
